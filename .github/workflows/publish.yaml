name: Publish Package

on:
  push:
    branches:
      - master
    tags:
      - "v*"

permissions:
  id-token: write
  contents: write
  pull-requests: write

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: "https://registry.npmjs.org"

      # npm Trusted Publishing éœ€è¦ npm CLI 11.5.1+
      - name: Upgrade npm
        run: npm install -g npm@latest

      # éªŒè¯ npm ç‰ˆæœ¬å’Œ OIDC é…ç½®
      - name: Verify npm and OIDC setup
        run: |
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "npm config registry: $(npm config get registry)"
          echo "OIDC token URL: $ACTIONS_ID_TOKEN_REQUEST_URL"
          echo "OIDC token present: ${ACTIONS_ID_TOKEN_REQUEST_TOKEN:+<set>}"

          # æµ‹è¯• npm whoamiï¼ˆOIDC å·¥ä½œæ—¶ä¸åº”è¯¥éœ€è¦ tokenï¼‰
          echo "Testing npm authentication..."
          npm whoami || echo "npm whoami test"

      # å®‰è£… pnpmï¼ˆç”¨äºæ„å»ºå’Œä¾èµ–ç®¡ç†ï¼‰
      - name: Install pnpm
        run: npm install -g pnpm

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install --force

      # æ„å»ºæ‰€æœ‰åŒ…
      - name: Build all packages
        run: pnpm run build

      - name: Apply patch versions
        run: npm version patch --workspaces --workspaces-update

      # æäº¤ç‰ˆæœ¬æ›´æ–°åˆ°ä»“åº“
      - name: Commit version updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore: version packages" || echo "No changes to commit"
          git push

      # ä½¿ç”¨ npm publish --workspaces ç›´æ¥å‘å¸ƒæ‰€æœ‰åŒ…ï¼ˆOIDC åŸç”Ÿæ”¯æŒï¼‰
      - name: Publish packages to npm using OIDC
        run: |
          echo "Publishing packages using npm OIDC..."
          npm publish --workspaces --workspaces-update --access public --provenance || true
        env:
          NPM_CONFIG_PROVENANCE: true
          NODE_AUTH_TOKEN: "" # æ˜ç¡®è®¾ç½®ä¸ºç©ºï¼Œå¼ºåˆ¶ä½¿ç”¨ OIDC

      # åˆ›å»º GitHub Release
      - name: Create GitHub Release
        run: |
          # è·å–ä¸»åŒ…çš„ç‰ˆæœ¬å·
          VERSION=$(node -p "require('./packages/runtime/package.json').version")
          echo "Creating release for version $VERSION"

          # ç”Ÿæˆ release notesï¼ˆåŒ…å«æ‰€æœ‰åŒ…çš„ç‰ˆæœ¬ä¿¡æ¯ï¼‰
          RELEASE_NOTES="## ğŸš€ Release v$VERSION\n\n"
          RELEASE_NOTES+="### ğŸ“¦ Published Packages\n\n"

          # æ”¶é›†æ‰€æœ‰å·²å‘å¸ƒçš„åŒ…ä¿¡æ¯
          for pkg in packages/*/package.json; do
            if [ -f "$pkg" ]; then
              PKG_NAME=$(node -p "require('./$pkg').name")
              PKG_VERSION=$(node -p "require('./$pkg').version")
              RELEASE_NOTES+="- **$PKG_NAME**: \`$PKG_VERSION\`\n"
            fi
          done

          RELEASE_NOTES+="\n---\n\n"
          RELEASE_NOTES+="âœ… Automatically published by GitHub Actions\n"

          # åˆ›å»º release
          gh release create "v$VERSION" \
            --title "ğŸ‰ v$VERSION" \
            --notes "$RELEASE_NOTES" \
            --generate-notes || echo "Release v$VERSION already exists or creation failed"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
